
# Candy API Server

Этот проект — результат выполнения задания **"Day 04 - Go Boot Camp"**. Основная цель — разработать API-сервер для автоматов по продаже конфет. Задача включает:

- Реализацию API, соответствующего требованиям Swagger-протокола.
- Реализацию проверки входных данных, расчёта сдачи и обработки ошибок.
- Добавление взаимной TLS-аутентификации для безопасности.
- Интеграцию внешнего ASCII-генератора.

## Технологии

- Go
- Swagger (go-swagger)
- OpenSSL
- TLS/SSL

## Доступные конфеты и их цены

| Код  | Название                | Цена (в центах) |
|------|-------------------------|-----------------|
| CE   | Cool Eskimo             | 10              |
| AA   | Apricot Aardvark        | 15              |
| NT   | Natural Tiger           | 17              |
| DE   | Dazzling Elderberry     | 21              |
| YR   | Yellow Rambutan         | 23              |

## Особенности

1. **Покупка конфет**:
   - Клиент отправляет запрос на сервер с информацией о количестве денег, типе конфет и их количестве.
   - Сервер рассчитывает сдачу или возвращает ошибку:
      - Если денег достаточно, ответ содержит "Спасибо!" и сдачу.
      - Если денег недостаточно, ответ содержит ошибку с указанием необходимой суммы.
      - Если ввод некорректен (отрицательное количество или несуществующий тип конфет), возвращается ошибка.

2. **Безопасность**:
   - Взаимная TLS-аутентификация реализована с использованием самоподписанных сертификатов.
   - Сервер и клиент используют сертификаты, подписанные локальным центром сертификации (CA), созданным с помощью [Minica](https://github.com/jsha/minica).

3. **Генерация кода**:
   - Код сервера и модели автоматически генерируются из спецификации Swagger 2.0 с помощью [go-swagger](https://github.com/go-swagger/go-swagger).

## Установка и выполнение

### Шаг 1. Клонирование репозитория
Клонируйте репозиторий:
```bash
git clone git@github.com:aventhis/candy-server-go.git
cd candy-server-go/src
```

### Шаг 2. Установка зависимостей
Убедитесь, что Go установлен, затем выполните:
```bash
go mod tidy
```

### Шаг 3. Генерация кода сервера из спецификации Swagger (если необходимо)
```bash
swagger generate server -f swagger.yaml -a candy-server
```

### Шаг 4. Использование Makefile
Для упрощения разработки и тестирования в проект включён `Makefile`. Основные команды:

- **Сборка сервера и клиента:**
  ```bash
  make all
  ```
- **Запуск сервера:**
  ```bash
  make start-server
  ```
- **Запуск клиента:**
  ```bash
  make start-client
  ```
- **Генерация сертификатов для сервера и клиента:**
  ```bash
  make generate-certs
  ```
- **Очистка бинарных файлов и сертификатов:**
  ```bash
  make clean clean-certs
  ```

Пример полного цикла:
```bash
make clean clean-certs
make generate-certs
make start-server
make start-client
```

### Шаг 5. Запуск сервера (ручной способ)
Вы также можете запустить сервер вручную с указанием путей к сертификатам:
```bash
go run cmd/candy-server-server/main.go --tls-port=3333 --tls-certificate=candy.tld/cert.pem --tls-key=candy.tld/key.pem --tls-ca=minica.pem
```

### Шаг 6. Запуск клиента (ручной способ)

Соберите и запустите клиента вручную:
```bash
go build candy-client.go
./candy-client -k <candy_type> -c <count> -m <money_amount>
```

Пример:
```bash
./candy-client -k AA -c 2 -m 50
```

## API

Методы и форматы запросов описаны в спецификации Swagger. Основной эндпоинт:
- `POST /buy_candy` - обработка покупки конфет.
